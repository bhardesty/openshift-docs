:_content-type: ASSEMBLY
[id="rosa-mobb-federating-system-user-metrics"]
= Tutorial: Federating system and user metrics to S3 in ROSA
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: rosa-mobb-federating-system-user-metrics

toc::[]

//Mobb content metadata
//Brought into ROSA product docs 2023-09-20
//---
//date: '2021-06-07'
//title: Federating System and User metrics to S3 in Red Hat OpenShift for AWS
//tags: ["AWS", "ROSA"]
//authors:
//  - Paul Czarkowski
//  - Michael Tipton
//---

This guide walks through setting up federating Prometheus metrics to S3 storage.

// ToDo - Add Authorization in front of Thanos APIs

[id="{context}-prerequisites"]
== Prerequisites

* A ROSA cluster (configured with STS)
* The `aws` CLI

[id="{context}-set-up-environment"]
== Set up environment

. Create environment variables:
+
[source,terminal]
----
$ export CLUSTER_NAME=my-cluster
$ export S3_BUCKET=my-thanos-bucket
$ export REGION=us-east-2
$ export NAMESPACE=federated-metrics
$ export SA=aws-prometheus-proxy
$ export SCRATCH_DIR=/tmp/scratch
$ export OIDC_PROVIDER=$(oc get authentication.config.openshift.io cluster -o json | jq -r .spec.serviceAccountIssuer| sed -e "s/^https:\/\///")
$ export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
$ export AWS_PAGER=""
$ rm -rf $SCRATCH_DIR
$ mkdir -p $SCRATCH_DIR
----

. Create a namespace:
+
[source,terminal]
----
$ oc new-project $NAMESPACE
----

[id="{context}-aws-preparation"]
== AWS preparation

. Create an S3 bucket:
+
[source,terminal]
----
$ aws s3 mb s3://$S3_BUCKET
----

. Create a policy for access to S3:
+
[source,terminal]
----
$ cat <<EOF > $SCRATCH_DIR/s3-policy.json
  {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Sid": "Statement",
              "Effect": "Allow",
              "Action": [
                  "s3:ListBucket",
                  "s3:GetObject",
                  "s3:DeleteObject",
                  "s3:PutObject",
                  "s3:PutObjectAcl"
              ],
              "Resource": [
                  "arn:aws:s3:::$S3_BUCKET/*",
                  "arn:aws:s3:::$S3_BUCKET"
              ]
          }
      ]
  }
  EOF
----

. Apply the policy:
+
[source,terminal]
----
$ S3_POLICY=$(aws iam create-policy --policy-name $CLUSTER_NAME-thanos \
    --policy-document file://$SCRATCH_DIR/s3-policy.json \
    --query 'Policy.Arn' --output text)

$ echo $S3_POLICY
----

. Create a trust policy:
+
[source,terminal]
----
$ cat <<EOF > $SCRATCH_DIR/TrustPolicy.json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {
          "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}"
        },
        "Action": "sts:AssumeRoleWithWebIdentity",
        "Condition": {
          "StringEquals": {
            "${OIDC_PROVIDER}:sub": [
              "system:serviceaccount:${NAMESPACE}:${SA}"
            ]
          }
        }
      }
    ]
  }
  EOF
----

. Create a role for AWS Prometheus and CloudWatch:
+
[source,terminal]
----
$ S3_ROLE=$(aws iam create-role \
    --role-name "$CLUSTER-thanos-s3" \
    --assume-role-policy-document file://$SCRATCH_DIR/TrustPolicy.json \
    --query "Role.Arn" --output text)

$ echo $S3_ROLE
----

. Attach the policies to the role:
+
[source,terminal]
----
$ aws iam attach-role-policy \
    --role-name "$CLUSTER-thanos-s3" \
    --policy-arn $S3_POLICY
----

////
. Grant access for the Thanos user to the S3 bucket:
+
[source,terminal]
----
$ aws s3api put-bucket-policy --bucket my-thanos-metrics \
    --policy file://s3-policy.json
----

. Get the account key and secret, and update them in `thanos-store-credentials.yaml`.
////

[id="{context}-deploy-operators"]
== Deploy Operators

. Add the MOBB chart repository to your Helm:
+
[source,terminal]
----
$ helm repo add mobb https://rh-mobb.github.io/helm-charts/
----

. Update your repositories:
+
[source,terminal]
----
$ helm repo update
----

. Use the `mobb/operatorhub` chart to deploy the needed Operators:
+
[source,terminal]
----
$ helm upgrade -n $echNAMESPACE custom-metrics-operators \
    mobb/operatorhub --version 0.1.1 --install \
    --values https://raw.githubusercontent.com/rh-mobb/helm-charts/main/charts/rosa-thanos-s3/files/operatorhub.yaml
----

[id="{context}-deploy-thanos-store-gateway"]
## Deploy Thanos Store Gateway

. Deploy the ROSA Thanos S3 Helm Chart:
+
[source,terminal]
----
$ helm upgrade -n $NAMESPACE rosa-thanos-s3 --install mobb/rosa-thanos-s3 \
    --set "aws.roleArn=$ROLE_ARN" \
    --set "rosa.clusterName=$CLUSTER_NAME"
----

. Append `remoteWrite` settings to the `user-workload-monitoring` config to forward user workload metrics to Thanos.

.. Check if the User Workload config map exists:
+
[source,terminal]
----
$ oc -n openshift-user-workload-monitoring get \
    configmaps user-workload-monitoring-config
----

.. If the config does not exist, run the following:
+
[source,terminal]
----
$ cat << EOF | kubectl apply -f -
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: user-workload-monitoring-config
    namespace: openshift-user-workload-monitoring
  data:
    config.yaml: |
      prometheus:
        remoteWrite:
          - url: "http://thanos-receive.${NAMESPACE}.svc.cluster.local:9091/api/v1/receive"
  EOF
----

.. Otherwise, update it with the following:
+
[source,terminal]
----
$ oc -n openshift-user-workload-monitoring edit \
    configmaps user-workload-monitoring-config

data:
  config.yaml: |
    ...
    prometheus:
    ...
      remoteWrite:
        - url: "http://thanos-receive.thanos-receiver.svc.cluster.local:9091/api/v1/receive"
----

[id="{context}-verify-metrics-flowing"]
== Verify metrics are flowing by logging into Grafana

. Get the route URL for Grafana (it should start with `https`), and log in using username `root` and the password (if you did not update the password, the default is `secret`):
+
[source,terminal]
----
$ oc -n thanos-receiver get route grafana-route
----

. Go to **Dashboards->Manage** and expand the **federated-metrics** group and you should see the cluster metrics dashboards. Select the **Use Method / Cluster** Dashboard and you should see metrics.
+
image::rosa-federated-grafana-metrics.png[Federated cluster metrics in Grafana]
